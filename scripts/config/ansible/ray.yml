---
- hosts: all
  vars:
    head_ip: 0.0.0.0
    mnt_path: /mnt/ebs0
    tmpfs_path: /mnt/tmpfs
    workdir: ~/raysort
    pythondir: ~/miniconda3/envs/raysort/bin
    clear_input_dir: false
    reinstall_ray: false
    ray_object_manager_port: 8076
    ray_merics_export_port: 8090
    ray_object_store_memory: "{{28 * 1024 * 1024 * 1024}}"
  tasks:
    - name: Install nightly Ray
      shell: "{{pythondir}}/pip install https://s3-us-west-2.amazonaws.com/ray-wheels/latest/ray-2.0.0.dev0-cp39-cp39-manylinux2014_x86_64.whl"
      when: reinstall_ray

    - name: Enable multiple s3 directories
      copy:
        src: /home/ubuntu/raysort/raysort/external_storage.py
        dest: /home/ubuntu/miniconda3/envs/raysort/lib/python3.9/site-packages/ray/external_storage.py

    - name: Clear tmpfs
      file:
        path: "{{tmpfs_path}}/raysort"
        state: absent

    - name: Clear temp directories
      become: yes
      file:
        path: "{{item.dir}}"
        state: absent
        mode: "777"
      when: item.when
      loop:
        - { dir: "{{mnt_path}}/tmp/input", when: "{{clear_input_dir}}" }
        - { dir: "{{mnt_path}}/tmp/output", when: true }
        - { dir: "{{mnt_path}}/tmp/ray", when: true }
        - { dir: "{{mnt_path}}/tmp/temp", when: true }

    - name: Restart Ray
      shell: >
        {{pythondir}}/ray stop -f &&
        sleep 3 &&
        nohup
        {{pythondir}}/ray start
        --address={{head_ip}}:6379
        --object-manager-port={{ray_object_manager_port}}
        --metrics-export-port={{ray_merics_export_port}}
        --resources='{"worker":1}'
        --object-store-memory={{ray_object_store_memory}}

    - name: Start Node Exporter
      shell: >
        nohup
        {{workdir}}/raysort/bin/node_exporter/node_exporter
        --web.listen-address 0.0.0.0:8091 &
